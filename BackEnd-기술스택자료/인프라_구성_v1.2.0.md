# 인프라 구성도

![image-20210119181223375](https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2FdeNsJI%2FbtqUk06IFe8%2F9KWYh9vxHwAEGiJsm6zAU0%2Fimg.png)



# AWS EC2 + Docker + Nginx

### 목표 

* Docker와 Nginx를 이용해 reverse proxy 서버를 구축하고 
  Nginx를 하나 더 이용해 static 서버를 구성



# EC2

### 환경 : ubuntu 18.04 LTS





# Docker

### 설치

```bash
#도커 패키지 설치 전 업데이트 수행
$ sudo apt-get update

#도커 패키지 설치
$ sudo apt-get install apt-transport-https ca-certificates curl gnupg-agent software-properties-common

#도커GPG 키 추가
$ curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -

#도커 GPG 키 확인
$ sudo apt-key fingerprint 0EBFCD88

#터미널에서 아래와 같이 뜨면 OK
====================================================================
pub   rsa4096 2017-02-22 [SCEA]
      9DC8 5822 9FC7 DD38 854A  E2D8 8D81 803C 0EBF CD88
uid           [ unknown] Docker Release (CE deb) <docker@docker.com>
sub   rsa4096 2017-02-22 [S]
====================================================================



#docker 저장소 등록
$ sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable"

#docker engine 설치
$ sudo apt-get update
sudo apt-get install docker-ce docker-ce-cli containerd.io

#docker engine 설치 확인
$ sudo docker run hello-world

//아래와 같이 나왔다면 설치 성공
====================================================================
Hello from Docker!
This message shows that your installation appears to be working correctly.

To generate this message, Docker took the following steps:
 1. The Docker client contacted the Docker daemon.
 2. The Docker daemon pulled the "hello-world" image from the Docker Hub.
    (amd64)
 3. The Docker daemon created a new container from that image which runs the
    executable that produces the output you are currently reading.
 4. The Docker daemon streamed that output to the Docker client, which sent it
    to your terminal.

To try something more ambitious, you can run an Ubuntu container with:
 $ docker run -it ubuntu bash

Share images, automate workflows, and more with a free Docker ID:
 https://hub.docker.com/

For more examples and ideas, visit:
 https://docs.docker.com/get-started/
====================================================================

```





# Docker Compose

### 설치

```bash
#안정적인 버전인 1.27.4 설치
$ sudo curl -L "https://github.com/docker/compose/releases/download/1.27.4/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose

#docker compose 권한 적용
$ sudo chmod +x /usr/local/bin/docker-compose

#docker compose 버전 확인
$ docker-compose --version

```



### docker-compose.yml

```yaml
version: '3'

services:
        redis :
                image : redis:5.0-alpine
                ports :
                        - 6379:6379
                          #networks :
                #       - backend_net
        spring :
                image : plover:1.0.0
                # networks:
                #       - backend_net
        nginx:
                image : nginx:1.18.0
                ports:
                        - 80:80
                        - 443:443

                volumes:
                        - ./nginx/nginx.conf:/etc/nginx/nginx.conf
                        - ./proxy:/etc/nginx/conf.d
                        - /etc/letsencrypt:/etc/letsencrypt
                        - /var/www/letsencrypt:/var/www/letsencrypt
                        - ./build:/var/www/html
#networks:
#    backend_net:
#        driver: bridge

```



### dockerfile

```dockerfile
#자바 버전
FROM openjdk:8-jdk

#포트
EXPOSE 8080

#애플리케이션 추가 (jar)
ADD ./webcuration-0.0.1-SNAPSHOT.jar plover.jar

#실행 명령
ENTRYPOINT ["java","-Djava.security.egd=file:/dev/./urandom","-jar","plover.jar"]
```



```bash
$ docker image build -t [넣고 싶은 이름(이미지 이름으로 사용함)] .
$ docker run --name [이름] [이미지 이름]
```







### Docker 명령어

```bash
# 이미지 받기
$ docker pull [OPTIONS] NAME[:TAG|@DIGEST]

# 이미지 보기
$ docker images [OPTIONS] [REPOSITORY[:TAG]]

# 이미지 태그 생성
$ docker tag SOURCE_IMAGE[:TAG] TARGET_IMAGE[:TAG]

# 이미지 삭제
$ docker rmi [OPTIONS] IMAGE [IMAGE...]

# 모든 이미지 삭제
$ docker rmi $(docker images -q)

# 컨테이너 실행
$ docker run [OPTIONS] IMAGE [COMMAND] [ARG...]

# 컨테이너 재실행
$ docker restart [OPTIONS] CONTAINER [CONTAINER...]

# 컨테이너 보기
$ docker ps [-option]

# 컨테이너 중지
$ docker stop [-option] [container ID]

# 컨테이너 삭제
$ docker rm [-option] [container ID]

# 중지된 컨테이너 삭제
$ docker rm $(docker ps -a -q -f status=exited)

# 모든 컨테이너 삭제
$ docker rm $(docker ps -qa)

# 도커HUB 로그인
$ docker login

# 도커HUB Repository에 push
$ docker push [OPTIONS] NAME[:TAG]
```





참고 : [Docker Doc](https://docs.docker.com/get-started/overview)





# Nginx

### 버전 

stable version인 nginx-1.18.0 를 사용합니다.



### 설치

```bash
# nginx 도커에 이미지 다운로드
$ sudo docker pull nginx

# nginx 테스트
$ sudo docker run --name nginx-server -d -p 80:80 nginx
```



### nginx.conf

```basic
# nginx.conf

user nginx;
worker_processes 1;

pid         /var/run/nginx.pid;

events {
    worker_connections  1024;
}

http {
    access_log  /var/log/nginx/access.log;
    error_log   /var/log/nginx/error.log;

    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    sendfile        on;
    keepalive_timeout  65;
    include /etc/nginx/conf.d/*.conf;

```



### proxy.conf

```
server {
    listen 80;

    server_name 54.180.105.93;

    location / {
        return 301 https://dev.plover.co.kr$request_uri;
    }
}

server {
    # 서버 포트를 80번으로 오픈
    listen 80;
    # 설정할 도메인(IP) 지정
    server_name dev.plover.co.kr;

    location / {
        return 301 https://$host$request_uri;
    }
    # 엑세스 로그, 오류 로그를 남길 파일 경로 지정
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;
}

server {
    # 서버 포트를 443번으로 오픈
    listen 443;
    # 설정할 도메인(IP) 지정
    server_name dev.plover.co.kr;

    root /var/www/html;
    index index.php index.html index.htm index.nginx-debian.html;

    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;

    location / {
                try_files $uri $uri/ /index.html;
    }

    location /ssafy {
        rewrite /ssafy/(.*) /ssafy/$1 break;
        #rewrite ^/ssafy(/.*)1 break;
        proxy_pass http://spring:8080;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Host $http_host;
#       proxy_redirect http://spring:8080 https://spring:8080;

```



### ~~init-letsencrypt.sh~~

```sh
#!/bin/bash

if ! [ -x "$(command -v docker-compose)" ]; then
  echo 'Error: docker-compose is not installed.' >&2
  exit 1
fi

domains=54.180.105.93;
rsa_key_size=4096
cert_path="./certbot"
email="ploverhelp@gmail.com" # Adding a valid address is strongly recommended
staging=0 # Set to 1 if you're testing your setup to avoid hitting request limits

if [ -d "$cert_path" ]; then
  read -p "Existing data found for $domains. Continue and replace existing certificate? (y/N) " decision
  if [ "$decision" != "Y" ] && [ "$decision" != "y" ]; then
    exit
  fi
fi


if [ ! -e "$cert_path/conf/options-ssl-nginx.conf" ] || [ ! -e "$cert_path/conf/ssl-dhparams.pem" ]; then
  echo "### Downloading recommended TLS parameters ..."
  mkdir -p "$cert_path/conf"
  curl -s https://raw.githubusercontent.com/certbot/certbot/master/certbot-nginx/certbot_nginx/_internal/tls_configs/options-ssl-nginx.conf > "$cert_path/conf/options-ssl-nginx.conf"
  curl -s https://raw.githubusercontent.com/certbot/certbot/master/certbot/certbot/ssl-dhparams.pem > "$cert_path/conf/ssl-dhparams.pem"
  echo
fi

echo "### Creating dummy certificate for $domains ..."
path="/etc/letsencrypt/live/$domains"
mkdir -p "$cert_path/conf/live/$domains"
docker-compose run --rm --entrypoint "\
  openssl req -x509 -nodes -newkey rsa:1024 -days 1\
    -keyout '$path/privkey.pem' \
    -out '$path/fullchain.pem' \
    -subj '/CN=localhost'" certbot
echo


echo "### Starting nginx ..."
docker-compose up --force-recreate -d nginx
echo

echo "### Deleting dummy certificate for $domains ..."
docker-compose run --rm --entrypoint "\
  rm -Rf /etc/letsencrypt/live/$domains && \
  rm -Rf /etc/letsencrypt/archive/$domains && \
  rm -Rf /etc/letsencrypt/renewal/$domains.conf" certbot
echo


echo "### Requesting Let's Encrypt certificate for $domains ..."
#Join $domains to -d args
domain_args=""
for domain in "${domains[@]}"; do
  domain_args="$domain_args -d $domain"
done

# Select appropriate email arg
case "$email" in
  "") email_arg="--register-unsafely-without-email" ;;
  *) email_arg="--email $email" ;;
esac

# Enable staging mode if needed
if [ $staging != "0" ]; then staging_arg="--staging"; fi

docker-compose run --rm --entrypoint "\
  certbot certonly --webroot -w /var/www/certbot \
    $staging_arg \
    $email_arg \
    $domain_args \
    --rsa-key-size $rsa_key_size \
    --agree-tos \
    --force-renewal" certbot
echo

echo "### Reloading nginx ..."
docker-compose exec nginx nginx -s reload
```



### dev infra server test

![img](https://blog.kakaocdn.net/dn/bwn0Yi/btqUmJci1UE/e3e0zQgVj5axp9ymjkarkK/img.png)







참고 :

프록시 서버란
https://interconnection.tistory.com/27

프록시 서버 예제
https://www.joinc.co.kr/w/man/12/proxy


프록시 서버, 캐시 서버, 웹 정적 서버
https://kscory.com/dev/nginx/setting

캐시 서버
https://www.joinc.co.kr/w/man/12/nginx/static


도커 compose
https://bum752.github.io/posts/Docker%EB%A5%BC-%EC%9D%B4%EC%9A%A9%ED%95%B4-%EC%9B%B9-%EC%95%A0%ED%94%8C%EB%A6%AC%EC%BC%80%EC%9D%B4%EC%85%98%EA%B3%BC-NGINX-%EC%82%AC%EC%9A%A9%ED%95%98%EA%B8%B0-(with-docker-compose)/

도커로 배포
https://medium.com/@nsh235482/docker%EB%A1%9C-%ED%98%91%EC%97%85%ED%95%98%EA%B8%B0-node-js-%EC%9B%B9%EC%84%9C%EB%B2%84%EB%A5%BC-docker%EB%A1%9C-%EB%B0%B0%ED%8F%AC%ED%95%98%EA%B8%B0-1475c33a4394

nginx
https://docs.nginx.com/nginx/admin-guide/web-server/web-server/
https://jojoldu.tistory.com/267



