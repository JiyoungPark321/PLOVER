# 인프라 구성도

![image-20210119181223375](https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2F4EHbn%2FbtqT17L4lsD%2F1oMVMnDMoVOCoyc2w2hcBK%2Fimg.png)



# AWS EC2 + Docker + Nginx

### 목표 

* Docker와 Nginx를 이용해 reverse proxy 서버를 구축하고 
  Nginx를 하나 더 이용해 static 서버를 구성



# EC2

### 환경 : ubuntu 18.04 LTS





# Docker

### 설치

```bash
#도커 패키지 설치 전 업데이트 수행
$ sudo apt-get update

#도커 패키지 설치
$ sudo apt-get install apt-transport-https ca-certificates curl gnupg-agent software-properties-common

#도커GPG 키 추가
$ curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -

#도커 GPG 키 확인
$ sudo apt-key fingerprint 0EBFCD88

#터미널에서 아래와 같이 뜨면 OK
====================================================================
pub   rsa4096 2017-02-22 [SCEA]
      9DC8 5822 9FC7 DD38 854A  E2D8 8D81 803C 0EBF CD88
uid           [ unknown] Docker Release (CE deb) <docker@docker.com>
sub   rsa4096 2017-02-22 [S]
====================================================================



#docker 저장소 등록
$ sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable"

#docker engine 설치
$ sudo apt-get update
sudo apt-get install docker-ce docker-ce-cli containerd.io

#docker engine 설치 확인
$ sudo docker run hello-world

//아래와 같이 나왔다면 설치 성공
====================================================================
Hello from Docker!
This message shows that your installation appears to be working correctly.

To generate this message, Docker took the following steps:
 1. The Docker client contacted the Docker daemon.
 2. The Docker daemon pulled the "hello-world" image from the Docker Hub.
    (amd64)
 3. The Docker daemon created a new container from that image which runs the
    executable that produces the output you are currently reading.
 4. The Docker daemon streamed that output to the Docker client, which sent it
    to your terminal.

To try something more ambitious, you can run an Ubuntu container with:
 $ docker run -it ubuntu bash

Share images, automate workflows, and more with a free Docker ID:
 https://hub.docker.com/

For more examples and ideas, visit:
 https://docs.docker.com/get-started/
====================================================================

```





# Docker Compose

### 설치

```bash
#안정적인 버전인 1.27.4 설치
$ sudo curl -L "https://github.com/docker/compose/releases/download/1.27.4/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose

#docker compose 권한 적용
$ sudo chmod +x /usr/local/bin/docker-compose

#docker compose 버전 확인
$ docker-compose --version

```



### docker-compose.yml

```yaml
version: "3.7"
#케쉬, 스테틱 서버 넣어야함
#java spring boot 넣어야함(엔드포인트 설정 잘하고 jar경로 설정 잘 하기)
services:
    nginx-proxy:
        image: nginx:1.17.8
        container_name: nginx-proxy
        hostname: nginx-proxy
        volumes:
            - ./conf.d/nginx:/etc/nginx/conf.d
            - certbot:/etc/letsencrypt
            - webroot:/var/www/certbot_webroot
        ports:
            - 80:80
            - 443:443
        restart: always
        environment:
            - APP_URL=${APP_URL}
            - PHPMYADMIN_URL=${PHPMYADMIN_URL}
            - CERTBOT_CERT_NAME=${CERTBOT_CERT_NAME}
        command: >
            /bin/bash -c "
                envsubst \"`env | awk -F = '{printf \" $$%s\", $$1}'`\" < /etc/nginx/conf.d/default.template > /etc/nginx/conf.d/default.conf \
                && exec nginx -g 'daemon off;'
            "
        networks:
            mynet:
                ipv4_address: #아이피 설정

    app:
        image: node:13.12.0
        container_name: app
        hostname: app
        working_dir: /var/www/html
        environment: 
            - MYSQL_HOST=mysql
            - MYSQL_USER=root
            - MYSQL_PASSWORD=${MYSQL_ROOT_PASSWORD}
        volumes: 
            - ./app:/var/www/html
        expose: 
            - 80
        command: "npm start"
        networks:
            mynet:
                ipv4_address: #아이피 설정

networks:
    mynet:
        name: #이름 설정해야함
        ipam:
            driver: default
            config:
                - subnet: #주소 설정해야함

volumes:
    certbot:
        name: certbot
    webroot:
        name: webroot
```









### Docker 명령어

```bash
# 이미지 받기
$ docker pull [OPTIONS] NAME[:TAG|@DIGEST]

# 이미지 보기
$ docker images [OPTIONS] [REPOSITORY[:TAG]]

# 이미지 태그 생성
$ docker tag SOURCE_IMAGE[:TAG] TARGET_IMAGE[:TAG]

# 이미지 삭제
$ docker rmi [OPTIONS] IMAGE [IMAGE...]

# 모든 이미지 삭제
$ docker rmi $(docker images -q)

# 컨테이너 실행
$ docker run [OPTIONS] IMAGE [COMMAND] [ARG...]

# 컨테이너 재실행
$ docker restart [OPTIONS] CONTAINER [CONTAINER...]

# 컨테이너 보기
$ docker ps [-option]

# 컨테이너 중지
$ docker stop [-option] [container ID]

# 컨테이너 삭제
$ docker rm [-option] [container ID]

# 중지된 컨테이너 삭제
$ docker rm $(docker ps -a -q -f status=exited)

# 모든 컨테이너 삭제
$ docker rm $(docker ps -qa)

# 도커HUB 로그인
$ docker login

# 도커HUB Repository에 push
$ docker push [OPTIONS] NAME[:TAG]
```





참고 : [Docker Doc](https://docs.docker.com/get-started/overview)





# Nginx

### 설치

```bash
# nginx 도커에 이미지 다운로드
$ sudo docker pull nginx

# nginx 테스트
$ sudo docker run --name nginx-server -d -p 80:80 nginx
```



### 설정

```
# 작업중
```



### react

##### 빌드

```bash
$ npm install
$ npm run build
```

* build 폴더안에 static 파일들이 build 되어 있음















