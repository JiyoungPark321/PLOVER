# 인프라 구성도

![image-20210119181223375](https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2F6k3oO%2FbtqT6HmHsYA%2FglF8fqNwTP1CJGLZNNV42K%2Fimg.png)



# AWS EC2 + Docker + Nginx

### 목표 

* Docker와 Nginx를 이용해 reverse proxy 서버를 구축하고 
  Nginx를 하나 더 이용해 static 서버를 구성



# EC2

### 환경 : ubuntu 18.04 LTS





# Docker

### 설치

```bash
#도커 패키지 설치 전 업데이트 수행
$ sudo apt-get update

#도커 패키지 설치
$ sudo apt-get install apt-transport-https ca-certificates curl gnupg-agent software-properties-common

#도커GPG 키 추가
$ curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -

#도커 GPG 키 확인
$ sudo apt-key fingerprint 0EBFCD88

#터미널에서 아래와 같이 뜨면 OK
====================================================================
pub   rsa4096 2017-02-22 [SCEA]
      9DC8 5822 9FC7 DD38 854A  E2D8 8D81 803C 0EBF CD88
uid           [ unknown] Docker Release (CE deb) <docker@docker.com>
sub   rsa4096 2017-02-22 [S]
====================================================================



#docker 저장소 등록
$ sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable"

#docker engine 설치
$ sudo apt-get update
sudo apt-get install docker-ce docker-ce-cli containerd.io

#docker engine 설치 확인
$ sudo docker run hello-world

//아래와 같이 나왔다면 설치 성공
====================================================================
Hello from Docker!
This message shows that your installation appears to be working correctly.

To generate this message, Docker took the following steps:
 1. The Docker client contacted the Docker daemon.
 2. The Docker daemon pulled the "hello-world" image from the Docker Hub.
    (amd64)
 3. The Docker daemon created a new container from that image which runs the
    executable that produces the output you are currently reading.
 4. The Docker daemon streamed that output to the Docker client, which sent it
    to your terminal.

To try something more ambitious, you can run an Ubuntu container with:
 $ docker run -it ubuntu bash

Share images, automate workflows, and more with a free Docker ID:
 https://hub.docker.com/

For more examples and ideas, visit:
 https://docs.docker.com/get-started/
====================================================================

```





# Docker Compose

### 설치

```bash
#안정적인 버전인 1.27.4 설치
$ sudo curl -L "https://github.com/docker/compose/releases/download/1.27.4/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose

#docker compose 권한 적용
$ sudo chmod +x /usr/local/bin/docker-compose

#docker compose 버전 확인
$ docker-compose --version

```



### docker-compose.yml

```yaml
#케쉬, 스테틱 서버 넣어야함
#java spring boot는 dokerfile로 설정하고 이 dokerfile을 가지고온다.
version: '3'

services:
		redis :
		
		spring :
			image : plover:1.0.0
        nginx:
        	image : nginx:1.18.0
        	ports:
        		- "80:80"
                - "443:443"

            volumes:
                - ./data/nginx.conf:/etc/nginx/nginx.conf
                #- ./data/nginx:/etc/nginx/conf.d
                #- ./data/certbot/conf:/etc/letsencrypt
                #- ./data/certbot/www:/var/www/certbot
            command: "/bin/sh -c 'while :; do sleep 6h & wait $${!}; nginx -s reload; done & nginx -g \"daemon off;\"'"

        certbot:
            image: certbot/certbot
            volumes:
                    - ./data/certbot/conf:/etc/letsencrypt
                    - ./data/certbot/www:/var/www/certbot
            entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew; sleep 12h & wait $${!}; done;'"


```



### dockerfile

```dockerfile
#자바 버전
FROM openjdk:8-jdk
#포트
EXPOSE 8080

#저장소 볼륨 추가
VOLUME /tmp

#애플리케이션 추가 (jar)
AGR JAR_FILE=/home/ubuntu/s04p11b118/backend/target/webcuration-0.0.1-SNAPSHOT.jar
COPY ${JAR_FILE} plover.jar

#실행 명령
ENTRYPOINT ["java","-Djava.security.egd=file:/dev/./urandom","-jar","plover.jar"]
```



```bash
$ docker image build -t [넣고 싶은 이름(이미지 이름으로 사용함)] .
$ docker run --name [이름] [이미지 이름]
```







### Docker 명령어

```bash
# 이미지 받기
$ docker pull [OPTIONS] NAME[:TAG|@DIGEST]

# 이미지 보기
$ docker images [OPTIONS] [REPOSITORY[:TAG]]

# 이미지 태그 생성
$ docker tag SOURCE_IMAGE[:TAG] TARGET_IMAGE[:TAG]

# 이미지 삭제
$ docker rmi [OPTIONS] IMAGE [IMAGE...]

# 모든 이미지 삭제
$ docker rmi $(docker images -q)

# 컨테이너 실행
$ docker run [OPTIONS] IMAGE [COMMAND] [ARG...]

# 컨테이너 재실행
$ docker restart [OPTIONS] CONTAINER [CONTAINER...]

# 컨테이너 보기
$ docker ps [-option]

# 컨테이너 중지
$ docker stop [-option] [container ID]

# 컨테이너 삭제
$ docker rm [-option] [container ID]

# 중지된 컨테이너 삭제
$ docker rm $(docker ps -a -q -f status=exited)

# 모든 컨테이너 삭제
$ docker rm $(docker ps -qa)

# 도커HUB 로그인
$ docker login

# 도커HUB Repository에 push
$ docker push [OPTIONS] NAME[:TAG]
```





참고 : [Docker Doc](https://docs.docker.com/get-started/overview)





# Nginx

### 버전 

stable version인 nginx-1.18.0 를 사용합니다.



### 설치

```bash
# nginx 도커에 이미지 다운로드
$ sudo docker pull nginx

# nginx 테스트
$ sudo docker run --name nginx-server -d -p 80:80 nginx
```



### 설정

```
# 작업중
```



### react

##### 빌드

```bash
$ npm install
$ npm run build
```

* build 폴더안에 static 파일들이 build 되어 있음















